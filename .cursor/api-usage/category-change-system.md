# Система зміни категорій користувачів УВР

## Загальний опис

Система зміни категорій користувачів УВР дозволяє автоматизувати процес верифікації та зміни категорій користувачів платформи. Система включає в себе:

1. Управління запитами на зміну категорії
2. Завантаження та верифікацію документів
3. Модерацію запитів адміністраторами
4. Автоматичне оновлення статусів

## Процес зміни категорії

### 1. Створення запиту

Користувач може створити запит на зміну своєї категорії через функцію `create_category_change_request`. При цьому:

- Перевіряється поточна категорія користувача
- Перевіряється відсутність активних запитів
- Створюється новий запит зі статусом "pending"

### 2. Завантаження документів

Після створення запиту користувач повинен завантажити необхідні документи:

- Система автоматично визначає необхідні документи на основі запитуваної категорії
- Кожен документ проходить валідацію (розмір, формат)
- Документи зберігаються в захищеному сховищі Supabase

### 3. Модерація

Адміністратори та модератори можуть обробляти запити через функцію `process_category_change_request`:

- Перегляд завантажених документів
- Перевірка відповідності документів
- Додавання коментарів
- Зміна статусу запиту

### 4. Автоматичне оновлення

При схваленні запиту система автоматично:

- Оновлює категорію користувача
- Встановлює статус верифікації
- Зберігає інформацію про модератора
- Оновлює часові мітки

## Таблиці бази даних

### category_change_requests
Зберігає інформацію про запити на зміну категорії:
- ID запиту
- Користувач
- Поточна та запитувана категорії
- Статус обробки
- Інформація про модерацію

### category_documents
Зберігає документи, завантажені користувачами:
- Зв'язок із запитом
- Інформація про файл
- Статус верифікації
- Коментарі модератора

### category_document_templates
Визначає необхідні документи для кожної категорії:
- Тип документа
- Обов'язковість
- Опис українською
- Порядок відображення

## Безпека та обмеження

1. **Перевірки доступу:**
   - Тільки адміністратори та модератори можуть обробляти запити
   - Користувачі можуть бачити тільки власні запити
   - Документи доступні тільки власнику та модераторам

2. **Валідація документів:**
   - Максимальний розмір файлу: 10MB
   - Підтримувані формати: JPEG, PNG, WebP, PDF
   - Перевірка шляху зберігання файлів

3. **Обмеження запитів:**
   - Один активний запит на користувача
   - Нова категорія повинна відрізнятися від поточної
   - Обов'язкова наявність всіх необхідних документів

## Використання API

### Створення запиту:
```sql
SELECT create_category_change_request(
  p_user_id := 'user-uuid',
  p_requested_category := 'active_military',
  p_reason := 'Повернення до військової служби'
);
```

### Обробка запиту:
```sql
SELECT process_category_change_request(
  p_request_id := 'request-uuid',
  p_reviewer_id := 'admin-uuid',
  p_new_status := 'approved',
  p_review_notes := 'Всі документи перевірено'
);
```

## Рекомендації для модераторів

1. **Перевірка документів:**
   - Перевіряйте актуальність дат на документах
   - Звіряйте особисті дані з профілем користувача
   - Перевіряйте чіткість та читабельність сканів

2. **Обробка запитів:**
   - Обробляйте запити в порядку надходження
   - Додавайте детальні коментарі при відхиленні
   - При необхідності додаткових документів використовуйте статус "requires_additional_docs"

3. **Комунікація:**
   - Використовуйте зрозумілі формулювання в коментарях
   - Вказуйте конкретні причини відхилення
   - Надавайте інструкції щодо виправлення помилок

## Технічна підтримка

При виникненні технічних проблем:
1. Перевірте журнали системи
2. Зверніться до технічної документації Supabase
3. Зв'яжіться з командою розробки УВР 