# Система зберігання файлів УВР

## Загальний опис

Система зберігання файлів Українського Військового Руху (УВР) забезпечує безпечне та ефективне управління документами, фотографіями та іншими файлами в проекті. Система розроблена з урахуванням вимог безпеки та оптимізації.

## Компоненти системи

### 1. Сховища (Storage Buckets)

#### category-documents
- Призначення: зберігання документів для верифікації категорій
- Доступ: приватний
- Ліміт розміру: 10MB
- Дозволені типи файлів: JPEG, PNG, WebP, PDF

#### avatars
- Призначення: аватари користувачів
- Доступ: публічний
- Ліміт розміру: 2MB
- Дозволені типи файлів: JPEG, PNG, WebP

#### project-files
- Призначення: документи проектів
- Доступ: приватний
- Ліміт розміру: 10MB
- Дозволені типи файлів: JPEG, PNG, WebP, PDF, DOC, DOCX

#### system-assets
- Призначення: системні файли
- Доступ: публічний
- Ліміт розміру: 5MB
- Дозволені типи файлів: JPEG, PNG, WebP, SVG

### 2. Безпека та права доступу

#### Загальні правила
- Кожен користувач має доступ тільки до своїх файлів
- Адміністратори мають доступ до всіх файлів
- Модератори мають доступ до документів верифікації
- Координатори проектів мають доступ до файлів своїх проектів

#### Політики безпеки
- Автоматична перевірка на віруси
- Валідація типів файлів
- Обмеження розміру файлів
- Безпечні імена файлів
- Signed URLs для приватних файлів

### 3. Оптимізація зображень

#### Автоматична обробка
- Створення мініатюр
- Стиснення зображень
- Видалення EXIF-даних
- Конвертація в оптимальні формати

#### Параметри оптимізації
- Максимальна ширина: 2048px
- Якість JPEG: 85%
- Формат WebP для веб
- Збереження оригіналів

### 4. Управління файлами

#### Функції для роботи з файлами
- `generate_safe_filename()` - генерація безпечних імен
- `get_document_signed_url()` - отримання тимчасових URL
- `cleanup_orphaned_files()` - очищення невикористаних файлів
- `get_storage_usage()` - статистика використання

#### Метадані файлів
- Оригінальна назва
- Розмір та тип
- Власник та зв'язки
- Статус обробки
- Результати сканування

## Інструкції з використання

### 1. Завантаження файлів

```typescript
// Приклад завантаження документа категорії
const uploadCategoryDocument = async (file: File) => {
  const { data, error } = await supabase.storage
    .from('category-documents')
    .upload(`${user.id}/${file.name}`, file, {
      cacheControl: '3600',
      upsert: false
    });
};
```

### 2. Отримання файлів

```typescript
// Приклад отримання signed URL
const getDocumentUrl = async (filePath: string) => {
  const { data } = await supabase.rpc('get_document_signed_url', {
    p_file_path: filePath
  });
  return data;
};
```

### 3. Видалення файлів

```typescript
// Приклад видалення аватара
const deleteAvatar = async (filePath: string) => {
  const { error } = await supabase.storage
    .from('avatars')
    .remove([filePath]);
};
```

## Рекомендації з безпеки

### 1. Для розробників
- Завжди використовуйте функцію `generate_safe_filename`
- Перевіряйте розмір та тип файлів
- Використовуйте тимчасові URL для приватних файлів
- Не зберігайте чутливі дані в іменах файлів

### 2. Для користувачів
- Завантажуйте тільки необхідні документи
- Використовуйте рекомендовані формати
- Не завантажуйте виконувані файли
- Регулярно перевіряйте свої завантаження

## Обмеження та квоти

### 1. Ліміти на файли
- Максимальний розмір файлу: 10MB
- Максимальна кількість файлів: без обмежень
- Загальний ліміт на користувача: 100MB
- Термін зберігання тимчасових файлів: 7 днів

### 2. Обмеження форматів
- Зображення: JPEG, PNG, WebP
- Документи: PDF, DOC, DOCX
- Системні файли: SVG додатково
- Заборонені формати: EXE, ZIP, RAR

## Моніторинг та обслуговування

### 1. Автоматичні процеси
- Щоденна перевірка на віруси
- Щотижневе очищення невикористаних файлів
- Щомісячний аудит використання
- Автоматична оптимізація зображень

### 2. Статистика та звіти
- Використання сховища
- Активність завантажень
- Статистика оптимізації
- Журнал доступу

## Розвиток системи

### Плановані покращення
1. Інтеграція з CDN
2. Розширена обробка документів
3. Покращені алгоритми стиснення
4. Розширена аналітика використання

### Масштабування
1. Балансування навантаження
2. Кешування файлів
3. Географічна реплікація
4. Оптимізація продуктивності 